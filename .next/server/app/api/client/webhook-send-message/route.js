(()=>{var e={};e.id=82,e.ids=[82],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1020:(e,t,r)=>{"use strict";r.d(t,{X:()=>i});var s=r(4882),n=r(6037),o=r.n(n);let a=s.x.mongoUrl;if(!a)throw Error("⚠️ MONGO_URI n\xe3o foi definida no .env");let i=async()=>{o().connection.readyState,await o().connect(a)}},1630:e=>{"use strict";e.exports=require("http")},1820:e=>{"use strict";e.exports=require("os")},2044:(e,t,r)=>{"use strict";r.d(t,{$:()=>p,T:()=>l});var s=r(4882),n=r(2719),o=r(2410),a=r(1020),i=r(4633),c=r(8509),d=r(6598),u=r(3657);let p=async e=>{let t=(await n.x.getState(e)).instance.state,r=async()=>{try{return await n.x.instanceConnect(e)}catch{throw Error("N\xe3o foi poss\xedvel gerar o qr-code!")}};switch(t){case o.d.OPEN:throw Error("Esse telofone j\xe1 est\xe1 conectado!");case o.d.CLOSE:return await r();case o.d.NOT_FOUND:try{return await n.x.newInstance({instanceName:e,integration:"WHATSAPP-BAILEYS",number:e,qrcode:!1,token:e,webhook:{events:["MESSAGES_UPSERT"],url:s.x.webhookSendMessageUrl||""}}),await r()}catch{throw Error("N\xe3o foi poss\xedvel gerar o qr-code durante a cria\xe7\xe3o da inst\xe2ncia!")}default:throw n.x.deleteInstance(e),Error("Erro inesperado!")}},l=async e=>{let t=new i.g(c.A,a.X),r=new d.R(u.A,a.X);try{let s=await t.getByTelephone(e);return await r.getAllByClientId(s._id)}catch{return[]}}},2410:(e,t,r)=>{"use strict";r.d(t,{d:()=>s});var s=function(e){return e.OPEN="open",e.CLOSE="close",e.NOT_FOUND="not_found",e}({})},2412:e=>{"use strict";e.exports=require("assert")},2719:(e,t,r)=>{"use strict";r.d(t,{x:()=>a});var s=r(4612),n=r(2410),o=r(4882);class a{static{this.httpClient=s.A.create({baseURL:o.x.evolutionBaseUrl,headers:{apiKey:o.x.evolutionApiKey}})}static async getState(e){let t=`instance/connectionState/${e}`;try{return(await this.httpClient.get(t)).data}catch{return{instance:{instanceName:e,state:n.d.NOT_FOUND}}}}static async newInstance(e){let t="instance/create";try{await this.httpClient.post(t,e)}catch{throw Error(t)}}static async instanceConnect(e){let t=`instance/connect/${e}`;try{let r=(await this.httpClient.get(t,{params:{number:e}})).data;if(!r.code||!r.base64||!r.pairingCode)throw Error(`${t}: Evolution codes not generated!`);return r}catch{throw Error(t)}}static async sendMessage(e,t){let r=`message/sendText/${e}`;try{await this.httpClient.post(r,t)}catch{throw Error(r)}}static async deleteInstance(e){let t=`instance/delete/${e}`;try{await this.httpClient.delete(t)}catch{throw Error(t)}}static async logoutInstance(e){let t=`instance/logout/${e}`;try{await this.httpClient.delete(t)}catch{throw Error(t)}}}},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3657:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(6037),n=r.n(s);let o=new s.Schema({title:{type:String,required:!0},description:{type:String,required:!0},clientId:{type:String,required:!0}},{timestamps:!0}),a=n().models.Info||n().model("Info",o)},3873:e=>{"use strict";e.exports=require("path")},3997:e=>{"use strict";e.exports=require("tty")},4075:e=>{"use strict";e.exports=require("zlib")},4633:(e,t,r)=>{"use strict";r.d(t,{g:()=>s});class s{constructor(e,t){this.clientModel=e,this.connect=t,this.connect()}async upsert(e){try{let t={telephone:e.telephone};return await this.clientModel.findOneAndUpdate(t,e,{upsert:!0,new:!0})}catch(e){throw Error("Client not created or updated!",{cause:e})}}async getByTelephone(e){try{let t=await this.clientModel.findOne({telephone:e});if(!t)throw Error("Client not found!");return t}catch(e){throw Error(e.message)}}async deleteByTelephone(e){try{let t=await this.clientModel.deleteOne({telephone:e});if(0===t.deletedCount)throw Error("None deleted!")}catch{throw Error("It was not possible delete user by db!")}}async decrementClientTokens(e){try{let t=await this.clientModel.updateOne({_id:e},{$inc:{messageTokens:-1}});if(0===t.modifiedCount)throw Error("None updated!")}catch{throw Error("It was not possible decrement user tokens!")}}async incrementClientTokens(e,t){try{let r=await this.clientModel.updateOne({_id:e},{$inc:{messageTokens:t}});if(0===r.modifiedCount)throw Error("None updated!")}catch{throw Error("It was not possible increment user tokens!")}}}},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4882:(e,t,r)=>{"use strict";r.d(t,{x:()=>s});let s={evolutionBaseUrl:process.env.EVOLUTION_BASE_URL,evolutionApiKey:process.env.EVOLUTION_API_KEY,mongoUrl:process.env.MONGO_URL,webhookSendMessageUrl:process.env.WEBHOOK_SEND_MESSAGE_URL,openAiBaseUrl:process.env.OPEN_AI_BASE_URL,openAiApiKey:process.env.OPEN_AI_API_KEY,stripeCallbackUrl:process.env.STRIPE_CALLBACK_URL,stripeApiCompleteKey:process.env.STRIPE_API_COMPLETE_KEY,stripePriceKey:process.env.STRIPE_PRICE_KEY}},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},6037:e=>{"use strict";e.exports=require("mongoose")},6487:()=>{},6598:(e,t,r)=>{"use strict";r.d(t,{R:()=>s});class s{constructor(e,t){this.infoModel=e,this.connect=t,this.connect()}async create(e){try{await this.infoModel.insertOne(e)}catch(e){throw Error("Info not created!",{cause:e})}}async update(e,t){try{let r=await this.infoModel.updateOne({_id:t},e);if(0===r.modifiedCount)throw Error("None updated!")}catch(e){throw Error("Info not updated!",{cause:e})}}async delete(e){try{let t=await this.infoModel.deleteOne({_id:e});if(0===t.deletedCount)throw Error("None deleted!")}catch(e){throw Error("Info not deleted!",{cause:e})}}async getAllByClientId(e){try{let t=await this.infoModel.find({clientId:e});if(0===t.length)throw Error("None info founded!");return t}catch(t){throw Error(`Infos of ${e} not founded!`,{cause:t})}}}},7069:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>f,serverHooks:()=>C,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{POST:()=>E});var n=r(6559),o=r(8088),a=r(7719),i=r(2190),c=r(2719),d=r(2044),u=r(4612),p=r(4882),l=function(e){return e.USER="user",e.DEVELOPER="developer",e}({});class h{static{this.httpClient=u.A.create({baseURL:p.x.openAiBaseUrl,headers:{Authorization:`Bearer ${p.x.openAiApiKey}`}})}static{this.iaContext=`Como um atendente feliz da loja, respondo todas as perguntas com base nas informa\xe7\xf5es fornecidas. 
  Se a mensagem n\xe3o estiver relacionada a esses dados, informarei que n\xe3o h\xe1 informa\xe7\xf5es dispon\xedveis. Minhas respostas sempre estar\xe3o 
  dentro do escopo de atendimento e das informa\xe7\xf5es dispon\xedveis, sem abordar assuntos fora desse contexto! Pode adicionar emojis nas 
  respostas, deixar bem humanizado.`}static async getResponse(e,t){let r="v1/responses",s={model:"gpt-4o",input:[{role:l.DEVELOPER,content:[{type:"input_text",text:this.iaContext}]},{role:l.DEVELOPER,content:e},{role:l.USER,content:[{type:"input_text",text:t}]}],text:{format:{type:"text"}},reasoning:{},tools:[],temperature:1,max_output_tokens:2048,top_p:1,store:!0};try{return(await this.httpClient.post(r,s)).data}catch{throw Error(r)}}}var w=r(4633),m=r(8509),x=r(1020);let y=new w.g(m.A,x.X);async function E(e){try{let t=await e.json(),r=await y.getByTelephone(t.instance);if(0===r.messageTokens)return i.NextResponse.json({message:"O cliente n\xe3o possue tokens suficientes!"},{status:403});if(!t.data.key.fromMe&&t.data.key.remoteJid.includes("@s.whatsapp.net")){let e=await (0,d.T)(t.instance);if(0===e.length)return await c.x.sendMessage(t.instance,{number:t.data.key.remoteJid.replace("@s.whatsapp.net",""),text:"Nenhuma informa\xe7\xe3o dispon\xedvel!"}),i.NextResponse.json({},{status:201});let s=e.map(e=>({type:"input_text",text:`${e.title}: ${e.description}`})),n=await h.getResponse(s,t.data.message.conversation);return await c.x.sendMessage(t.instance,{number:t.data.key.remoteJid.replace("@s.whatsapp.net",""),text:n.output[0].content[0].text}),await y.decrementClientTokens(r._id),i.NextResponse.json({},{status:201})}return i.NextResponse.json({},{status:400})}catch{return i.NextResponse.json({message:"Nenhum dado enviado!"},{status:400})}}let f=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/client/webhook-send-message/route",pathname:"/api/client/webhook-send-message",filename:"route",bundlePath:"app/api/client/webhook-send-message/route"},resolvedPagePath:"/home/fr/atendente-bot/src/app/api/client/webhook-send-message/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:v,serverHooks:C}=f;function _(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:v})}},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},8354:e=>{"use strict";e.exports=require("util")},8509:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(6037),n=r.n(s);let o=new s.Schema({telephone:{type:String,required:!0},authCode:{type:String,required:!0},messageTokens:{type:Number,required:!1}},{timestamps:!0}),a=n().models.Client||n().model("Client",o)},9021:e=>{"use strict";e.exports=require("fs")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9551:e=>{"use strict";e.exports=require("url")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,580,612],()=>r(7069));module.exports=s})();